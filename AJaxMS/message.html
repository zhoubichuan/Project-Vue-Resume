<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>留言本</title>
	<link rel="stylesheet" href="css.css" type="text/css" />
    <script src="ajax.js"></script>
    <script src="guestbook.js"></script>
</head>

<body>
	<h1 id="header">联系我</h1>

	<div id="container">
		<!-- 留言发表 -->
			<div id="sendBox">
				<h4>发表留言</h4>
				<div>
					<textarea id="content"></textarea>
					<input type="button" value="提交" class="btn1" id="btnPost" />
				</div>
			</div>
		
		<div id="list">
		<!--<dl>
				<dt>
					<strong>zmouse</strong> 说 :
				</dt>
				<dd>内容</dd>
				<dd class="t">
					<a href="javascript:;" id="support">顶(<span>0</span>)</a>
					 | 
					<a href="javascript:;" id="oppose">踩(<span>0</span>)</a>
				</dd>
			</dl>-->
		</div>
		
        <div id="showMore">显示更多...</div>

		<div id="sidebar">
        
        	<div id="user" style="margin-bottom: 10px;">
            	<h4><span id="userinfo"></span> <a href="" id="logout">退出</a></h4>
            </div>
        
			<!-- 注册 -->
			<div id="reg">
				<h4>注册</h4>
				<div>
					<p>用户名：<input type="text" name="username" id="username1"></p>
                    <p id="verifyUserNameMsg"></p>
					<p>密码：<input type="password" name="password" id="password1"></p>
                    <p><input type="button" value="注册" id="btnReg" /></p>
				</div>
			</div>
				
			<!-- 登陆 -->
			<div id="login">
				<h4>登陆</h4>
				<div>
					<p>用户名：<input type="text" name="username2" id="username2"></p>
					<p>密码：<input type="password" name="password2" id="password2"></p>
                    <p><input type="button" value="登陆" id="btnLogin" /></p>
				</div>
			</div>
			
			
		</div>

	</div>
	<script>
		var username2=document.getElementById('username2');
		var password2=document.getElementById('password2');
		var btnLogin=document.getElementById('btnLogin');
		var user = document.getElementById('user');
		var logout = document.getElementById('logout');
		var userinfo = document.getElementById('userinfo');
		function getCookie(key){
			var arr1 = document.cookie.split('; ');			
			for (var i=0; i<arr1.length; i++) {
				var arr2 = arr1[i].split('=');
				if (arr2[0]==key) {
					return decodeURI(arr2[1]);
				}
			}	
		};
		function updateUserStatus(){
			var uid=getCookie('uid');
			var username=getCookie('username');
			if(uid){
				user.style.display='block';
				userinfo.innerHTML=username;
				reg.style.display='none';
				login.style.display='none';
			}else{
				user.style.display='none';
				userinfo.innerHTML='';
				reg.style.display='block';
				login.style.display='block';
			}	
		}
		updateUserStatus();
		//注册
		var username1=document.getElementById('username1');
		var password1=document.getElementById('password1');
		var btnReg=document.getElementById('btnReg');
		var verifyUserNameMsg=document.getElementById('verifyUserNameMsg');
		username1.onblur=function(){		
		ajax('post','guestbook/index.php','m=index&a=verifyUserName&username='+username1.value+'',function(data){
			verifyUserNameMsg.innerHTML=JSON.parse(data).message;
			if(JSON.parse(data).code){
				verifyUserNameMsg.style.color='red';
			}else{
				verifyUserNameMsg.style.color='green';
			}
		});
		}
		btnReg.onclick=function(){
			ajax('post','guestbook/index.php','m=index&a=reg&username='+username1.value+'&password='+password1.value+'',function(data){
			username1.value='';
			password1.value='';
			verifyUserNameMsg.innerHTML='';
			alert(JSON.parse(data).message);
			});
		}
		//登录
		
		updateUserStatus()
		btnLogin.onclick=function(){
			ajax('post','guestbook/index.php','m=index&a=login&username='+username2.value+'&password='+password2.value+'',function(data){
			username2.value='';
			password2.value='';
			alert(JSON.parse(data).message);
			updateUserStatus();
			});
		}
			
		
		
		logout.onclick = function(){
			
			ajax('get', 'guestbook/index.php', 'm=index&a=logout', function(data){
				alert(JSON.parse(data).message);
				//用户退出
				if(!JSON.parse(data).code)
				{
					updateUserStatus()
				}
			});	
			return false;
		};	
		
		//留言
		var content=document.getElementById('content');
		var btnPost=document.getElementById('btnPost');
		var sendBox=document.getElementById('sendBox');
		var list=document.getElementById('list');
		var showMore=document.getElementById('showMore');
		btnPost.onclick=function(){
		ajax('post','guestbook/index.php','m=index&a=send&content='+content.value+'',function(data){
			content.value='';
//			alert(JSON.parse(data).message)
			if(!JSON.parse(data).code){
			createList(JSON.parse(data).data,true)	
		}
		});	
		}
		var iPage=1;
		showMore.onclick=function(){
			iPage++;
			ajax('post','guestbook/index.php','m=index&a=getList&n=2&page='+iPage,function(data){
				for(var i=0;i<JSON.parse(data).data.list.length;i++){
				createList(JSON.parse(data).data.list[i],true)
				}	
		});	
		}
		function createList(data,insert){
			var dl=document.createElement('dl')
			list.appendChild(dl)
			var dt=document.createElement('dt')
			dl.appendChild(dt)
			var strong=document.createElement('strong')
			dt.appendChild(strong)
			strong.innerHTML=data.username+'  留言：';
			var dd=document.createElement('dd')
			dd.innerHTML='内容:'+data.content;
			dl.appendChild(dd)
			
			var dd=document.createElement('dd')
			dd.className='t'
			dl.appendChild(dd)
			var a=document.createElement('a')
			a.href='javascript:;'
			a.id='support'
			
			a.innerHTML='踩(<span>'+data.support+'</span>)';
			dd.appendChild(a);
			var a=document.createElement('a');
			a.href='javascript:;'
			a.id='oppose';
			console.log(data)
			a.innerHTML='顶(<span>'+data.oppose+'</span>)'
			dd.appendChild(a)
			var span=document.createElement('span')
			var arr=new Array();
			arr[0]=t=Math.floor(data.dateline/1000/60/60/24);
			arr[1]=s=Math.floor(data.dateline/1000/60/60)-24*t;
			arr[2]=f=Math.floor(data.dateline/1000/60)-60*s-1440*t;
			arr[3]=m=Math.floor(data.dateline/1000)-60*f-3600*s-86400*t;
			str=arr.join('')
			span.style.color='red';
			span.style.fontSize='12px'
			span.innerHTML='<span>'+arr[0]+'年'+(arr[1]+12)+'点'+arr[2]+'分钟'+arr[3]+'秒'+'</span>'
			dd.appendChild(span)
			if (insert && list.children[0]) {
				list.insertBefore(dl, list.children[0]);
			} else {
				list.appendChild(dl);
			}
		}
		
//		var support=document.getElementById('support');
//			support.onclick=function(){
//			data.support+=1;	
//			}
//		var support=document.getElementById('oppose');
//			oppose.onclick=function(){
//			data.oppose+=1;	
//			}
	</script>
</body>
</html>